<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lobby-Übersicht</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: sans-serif;
            margin: 0;
            padding: 2rem;
        }
        
        h1,
        h2 {
            text-align: center;
        }
        
        #spielerListe {
            max-width: 600px;
            margin: 2rem auto;
            background: #1e1e1e;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }
        
        .spieler {
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
        }
        
        #startButton {
            display: block;
            margin: 2rem auto;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            color: #ffffff;
            background-color: #6200ea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        
        #startButton:disabled {
            background-color: #444;
            cursor: not-allowed;
        }
        
        #startButton:hover:not(:disabled) {
            background-color: #3700b3;
        }

        #spielAuswahl {
            display: none;
            text-align: center;
            margin-top: 2rem;
        }

        #spielSelect {
            font-size: 1.2rem;
            padding: 0.5rem;
        }

        #spielSetzenBtn {
            margin-left: 1rem;
            font-size: 1.1rem;
            padding: 0.5rem 1.2rem;
        }

        #auswahlStatus {
            color: #bdbdbd;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <h1>Lobby</h1>
    <h2 id="pinAnzeige">PIN: </h2>
    <div id="spielerListe">Spieler werden geladen...</div>
    <button id="startButton">Spiel starten</button>
    <div id="spielAuswahl" style="display:none; text-align:center;">
        <h2>Nächstes Spiel auswählen</h2>
        <select id="spielSelect" style="font-size:1.2rem; padding:0.5rem;">
            <!-- Optionen werden per JS eingefügt -->
        </select>
        <button id="spielSetzenBtn" style="margin-left:1rem; font-size:1.1rem; padding:0.5rem 1.2rem;">Spiel setzen</button>
        <p id="auswahlStatus" style="color:#bdbdbd; margin-top:1rem;"></p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        document.getElementById("pinAnzeige").textContent = `PIN: ${pin}`;

        async function ladeSpieler() {
            try {
                // Spieler abrufen
                const response = await fetch(`https://kk-backend.vercel.app/getAllPlayersOfLobby?lobby=${pin}`);
                const data = await response.json();
                console.log(data)
                const liste = document.getElementById("spielerListe");
                console.log(liste)
                liste.innerHTML = "";

                if (Array.isArray(data)) {
                    data.forEach(spieler => {
                        const el = document.createElement("div");
                        el.className = "spieler";
                        el.textContent = spieler;
                        liste.appendChild(el);
                    });
                } else {
                    liste.textContent = "Keine Spieler gefunden.";
                }
            } catch (err) {
                console.error("Fehler beim Laden der Spieler:", err);
                document.getElementById("spielerListe").textContent = "Fehler beim Laden.";
            }
        }

        async function pruefeSpielGestartet() {
            try {
                // Prüfen, ob das Spiel gestartet ist
                const response = await fetch(`https://kk-backend.vercel.app/gehtsLos?lobby=${pin}`);
                const spielGestartet = await response.json();

                if (spielGestartet) {
                    document.getElementById("startButton").disabled = true;
                    document.getElementById("startButton").textContent = "Spiel läuft bereits";
                }
            } catch (err) {
                console.error("Fehler beim Prüfen des Spielstatus:", err);
            }
        }

        // Spielauswahl-Elemente
        const startButton = document.getElementById("startButton");
        const spielAuswahlDiv = document.getElementById("spielAuswahl");
        const spielSelect = document.getElementById("spielSelect");
        const spielSetzenBtn = document.getElementById("spielSetzenBtn");
        const auswahlStatus = document.getElementById("auswahlStatus");

        // Optionen für Spiele 1-20 einfügen
        for (let i = 1; i <= 20; i++) {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = `Spiel ${i}`;
            spielSelect.appendChild(opt);
        }

        let auswahlPolling = null;

        async function checkNaechstesSpiel() {
            try {
                const res = await fetch(`https://kk-backend.vercel.app/naechstesSpiel?lobby=${pin}`);
                const val = await res.json();
                // Wenn ein Spiel gesetzt wurde, Auswahl deaktivieren
                if (val !== false && val !== null) {
                    spielAuswahlDiv.style.display = "none";
                    auswahlStatus.textContent = "";
                    if (auswahlPolling) clearInterval(auswahlPolling);
                } else {
                    spielAuswahlDiv.style.display = "block";
                }
            } catch (e) {
                // Fehler ignorieren lol
            }
        }

        async function starteSpiel() {
            // Erstes Mal starten: losGehts-Request senden
            try {
                await fetch(`https://kk-backend.vercel.app/losGehts?lobby=${pin}`);
            } catch (e) {
                // Fehler ignorieren, trotzdem fortfahren
            }
            // Ansicht wechseln
            startButton.style.display = "none";
            spielAuswahlDiv.style.display = "block";
            auswahlStatus.textContent = "";
            // Polling starten, um zu prüfen, ob schon ein Spiel gesetzt wurde
            if (auswahlPolling) clearInterval(auswahlPolling);
            auswahlPolling = setInterval(checkNaechstesSpiel, 1000);
            // Initial prüfen
            checkNaechstesSpiel();
        }

        spielSetzenBtn.addEventListener("click", async () => {
            const spielid = spielSelect.value;
            try {
                const res = await fetch(`https://kk-backend.vercel.app/changeNaechstesSpiel?lobby=${pin}&spielid=${spielid}`);
                if (res.ok) {
                    auswahlStatus.textContent = "Spiel gesetzt!";
                } else {
                    auswahlStatus.textContent = "Fehler beim Setzen des Spiels.";
                }
            } catch (e) {
                auswahlStatus.textContent = "Fehler beim Setzen des Spiels.";
            }
        });

        startButton.addEventListener("click", starteSpiel);


        ladeSpieler();
        pruefeSpielGestartet();

        setInterval(() => {
            ladeSpieler();
            pruefeSpielGestartet();
        }, 1000);
    </script>
</body>

</html>